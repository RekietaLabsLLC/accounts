<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>MyLabs Account - Login</title>
<link rel="icon" href="MyLabsLogo.png" type="image/png"/>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background-color: #0a0a0a;
    color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }
  .container {
    background-color: #111;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    width: 100%;
    max-width: 400px;
    text-align: center;
  }
  h1 { color: #1753aa; margin-bottom: 1.5rem; }
  input[type="email"], input[type="password"] {
    width: 100%;
    padding: 10px;
    margin-bottom: 1rem;
    border: none;
    border-radius: 6px;
    background-color: #222;
    color: white;
    font-size: 1rem;
  }
  button {
    width: 100%;
    padding: 10px;
    background-color: #1753aa;
    border: none;
    border-radius: 6px;
    color: white;
    font-size: 1rem;
    cursor: pointer;
  }
  .divider { margin: 1.5rem 0; color: #aaa; font-size: 0.9rem; }
  .github-button {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    background-color: #333;
    padding: 10px;
    border-radius: 6px;
    text-decoration: none;
    color: white;
    cursor: pointer;
  }
  .github-button img { height: 24px; width: 24px; border-radius: 50%; }
  .error-msg { color: #1753aa; margin-bottom: 1rem; font-size: 0.9rem; }
</style>
</head>
<body>
<div class="container">
  <h1>Login</h1>
  <div id="error-container" class="error-msg"></div>

  <form id="login-form">
    <input type="email" id="email" placeholder="Email" required />
    <input type="password" id="password" placeholder="Password" required />
    <button type="submit">Login</button>
  </form>

  <div class="divider">or</div>

  <div id="github-btn" class="github-button">
    <img id="github-logo" src="/mylabs/github-mark.png" alt="GitHub Logo" />
    <span id="github-text">Login with GitHub</span>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1/dist/supabase.min.js"></script>
<script>
const errorContainer = document.getElementById("error-container");
let supabase;

async function loadConfig() {
  try {
    const res = await fetch("https://api.rekietalabs.com/config-login");
    if (!res.ok) throw new Error(`Failed to load login config: ${res.status}`);
    const data = await res.json();
    supabase = Supabase.createClient(data.supabaseUrl, data.supabaseAnonKey);
  } catch (err) {
    console.error("Config load error:", err);
    errorContainer.textContent = `Error loading login config: ${err.message}`;
  }
}

await loadConfig();

if (!supabase) {
  errorContainer.textContent = "Supabase not initialized.";
}

// Redirect based on user plan
async function redirectByPlan(userId) {
  try {
    const { data: sub, error: subErr } = await supabase
      .from('user_subscriptions')
      .select('plan')
      .eq('user_id', userId)
      .single();
    if (subErr) throw subErr;

    if (!sub || !sub.plan || sub.plan === "not-selected") {
      window.location.href = '/mylabs/pick-plan';
    } else {
      window.location.href = '/mylabs/dashboard';
    }
  } catch (err) {
    console.error("Error checking plan:", err);
    errorContainer.textContent = `Error checking plan: ${err.message}`;
  }
}

// Email/password login
document.getElementById("login-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  errorContainer.textContent = "";
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  try {
    const { user, error } = await supabase.auth.signIn({ email, password });
    if (error) throw error;
    redirectByPlan(user.id);
  } catch (err) {
    console.error("Login error:", err);
    errorContainer.textContent = `Login error: ${err.message}`;
  }
});

// GitHub login
document.getElementById("github-btn").addEventListener("click", async () => {
  errorContainer.textContent = "";
  try {
    const { error } = await supabase.auth.signIn({
      provider: "github",
      options: { redirectTo: "https://accounts.rekietalabs.com/mylabs/login" }
    });
    if (error) throw error;
  } catch (err) {
    console.error("GitHub OAuth error:", err);
    errorContainer.textContent = `GitHub OAuth error: ${err.message}`;
  }
});

// Handle OAuth redirect
async function handleOAuthRedirect() {
  try {
    const session = supabase.auth.session(); // v1: get current session from storage
    if (!session || !session.user) return;

    const user = session.user;
    const firstName = (user.user_metadata?.full_name || user.email).split(" ")[0];

    // Update button text
    const githubText = document.getElementById("github-text");
    const githubLogo = document.getElementById("github-logo");
    githubText.textContent = `Continue as ${firstName}`;
    githubLogo.src = user.user_metadata?.avatar_url || "/mylabs/github-mark.png";

    // Redirect based on plan
    redirectByPlan(user.id);
  } catch (err) {
    console.error("OAuth redirect error:", err);
    errorContainer.textContent = `OAuth redirect error: ${err.message}`;
  }
}

window.addEventListener("load", handleOAuthRedirect);
</script>
</body>
</html>
